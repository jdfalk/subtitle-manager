# file: .github/workflows/pr-automation.yml
# version: 4.2.0
# guid: a7b8c9d0-e1f2-3456-a789-0123456789bc
# NOTE: This file should be updated in ghcommon repository first, then copied to other repositories.
# To update: Edit in https://github.com/jdfalk/ghcommon/.github/workflows/pr-automation.yml then copy to other repos

name: PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled, unlabeled]
  pull_request_target:
    types: [opened, edited, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write
  security-events: write
  actions: write
  packages: read
  id-token: write
  repository-projects: write

env:
  VALIDATE_ALL_CODEBASE: false
  DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
  FILTER_REGEX_EXCLUDE: ".*\\.git/.*|.*\\.github/copilot/.*|.*\\.vscode/.*|.*node_modules/.*|.*\\.cache/.*|.*vendor/.*|.*dist/.*"

jobs:
  # Primary code quality check - runs on all PRs
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Super Linter environment
        run: |
          echo "Setting up Super Linter environment..."
          echo "VALIDATE_ALL_CODEBASE=false" >> $GITHUB_ENV
          echo "DEFAULT_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
          echo "FILTER_REGEX_EXCLUDE=${{ env.FILTER_REGEX_EXCLUDE }}" >> $GITHUB_ENV

      - name: Run Super Linter
        id: run-super-linter
        uses: github/super-linter/slim@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: ${{ env.VALIDATE_ALL_CODEBASE }}
          DEFAULT_BRANCH: ${{ env.DEFAULT_BRANCH }}
          FILTER_REGEX_EXCLUDE: ${{ env.FILTER_REGEX_EXCLUDE }}

          # Enable validations (only for linters without FIX options)
          VALIDATE_YAML: true
          VALIDATE_PYTHON_PYLINT: false
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true
          VALIDATE_HTML: true
          VALIDATE_GITHUB_ACTIONS: true
          VALIDATE_GITLEAKS: true
          VALIDATE_DOCKERFILE_HADOLINT: true

          # Auto-fix settings - Prettier prioritized for formatting
          FIX_ANSIBLE: true
          FIX_CLANG_FORMAT: true
          FIX_CSHARP: true
          FIX_CSS_PRETTIER: true  # Prettier for CSS formatting
          FIX_ENV: true
          FIX_GO: true
          FIX_GO_MODULES: true
          FIX_GROOVY: true
          FIX_JAVASCRIPT_ES: true      # ESLint for JavaScript validation
          FIX_JAVASCRIPT_PRETTIER: true  # Prettier for JavaScript formatting
          FIX_JSON_PRETTIER: true     # Prettier for JSON formatting
          FIX_MARKDOWN: true
          FIX_POWERSHELL: true
          FIX_PROTOBUF: true
          FIX_PYTHON_BLACK: true
          FIX_PYTHON_ISORT: true
          FIX_PYTHON_RUFF: true
          FIX_RUST_2015: true
          FIX_RUST_2018: true
          FIX_RUST_2021: true
          FIX_RUST_CLIPPY: true
          FIX_SHELL_SHFMT: true
          FIX_SNAKEMAKE_SNAKEFMT: true
          FIX_TERRAFORM_FMT: true
          FIX_TYPESCRIPT_ES: true      # ESLint for TypeScript validation
          FIX_TYPESCRIPT_PRETTIER: true  # Prettier for TypeScript formatting

      - name: Check for auto-fixes
        id: check-fixes
        run: |
          if ! git diff --quiet; then
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "Auto-fixes were applied by Super Linter"
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "No auto-fixes were applied"
          fi

      - name: Commit and push auto-fixes
        if: steps.check-fixes.outputs.has_fixes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          echo "Staging auto-fixes..."
          git add -A

          # Create detailed commit message
          FIXED_FILES=$(git diff --cached --name-only | head -10)
          TOTAL_FILES=$(git diff --cached --name-only | wc -l)

          echo "style: auto-fix linting issues [skip ci]" > commit_msg.txt
          echo "" >> commit_msg.txt
          echo "Auto-formatting and fixes applied by Super Linter." >> commit_msg.txt
          echo "" >> commit_msg.txt
          echo "Files changed:" >> commit_msg.txt

          echo "$FIXED_FILES" | while IFS= read -r file; do
            echo "- $file - Auto-formatting applied" >> commit_msg.txt
          done

          if [ "$TOTAL_FILES" -gt 10 ]; then
            echo "- ... and $((TOTAL_FILES - 10)) more files" >> commit_msg.txt
          fi

          git commit -F commit_msg.txt
          rm commit_msg.txt

          echo "Pushing auto-fixes..."
          git push
          echo "âœ… Auto-fixes committed and pushed successfully"

      - name: Create Job Summary
        if: always()
        run: |
          echo "# ðŸ” Super Linter Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-super-linter.outcome }}" = "success" ]; then
            echo "âœ… **All code quality checks passed!**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.run-super-linter.outcome }}" = "failure" ]; then
            echo "âŒ **Issues found that need attention**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Linter status unknown** - check workflow logs" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show auto-fixes if applied
          if [ "${{ steps.check-fixes.outputs.has_fixes }}" = "true" ]; then
            echo "## ðŸ”§ Auto-fixes Applied" >> $GITHUB_STEP_SUMMARY
            echo "Auto-formatting fixes were applied and committed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Changed files only" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-fix**: true" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-commit**: true" >> $GITHUB_STEP_SUMMARY

      - name: Upload Super Linter results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-output-${{ github.run_id }}-${{ github.run_attempt }}
          path: super-linter-output/
          retention-days: 7

  # File-pattern based auto-labeling
  auto-labeling:
    name: Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Apply file-based labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  # Intelligent AI-powered labeling
  intelligent-labeling:
    name: Intelligent AI Labeling
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'edited'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml python-dateutil scikit-learn nltk

      - name: Download NLTK data
        run: |
          python -c "
          import nltk
          nltk.download('punkt')
          nltk.download('stopwords')
          nltk.download('vader_lexicon')
          "

      - name: Run intelligent labeling
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > intelligent_labeling.py
          import os
          import requests
          import json
          import re
          from collections import defaultdict

          def analyze_pr_content(title, body, changed_files):
              """Basic intelligent labeling based on content analysis"""
              labels = []

              # Analyze title and body
              text = (title + " " + (body or "")).lower()

              # Bug fixes
              if any(word in text for word in ['fix', 'bug', 'error', 'issue', 'problem']):
                  labels.append('bug')

              # Features
              if any(word in text for word in ['feature', 'add', 'new', 'implement']):
                  labels.append('enhancement')

              # Documentation
              if any(word in text for word in ['doc', 'readme', 'documentation']):
                  labels.append('documentation')

              # Tests
              if any(word in text for word in ['test', 'testing', 'spec']):
                  labels.append('tests')

              # Analyze changed files
              for file in changed_files:
                  file_lower = file.lower()
                  if file_lower.endswith(('.md', '.rst')):
                      labels.append('documentation')
                  elif file_lower.endswith(('.go')):
                      labels.append('go')
                  elif file_lower.endswith(('.js', '.ts', '.jsx', '.tsx')):
                      labels.append('frontend')
                  elif file_lower.endswith(('.py')):
                      labels.append('python')
                  elif file_lower.endswith(('dockerfile', '.docker')):
                      labels.append('docker')
                  elif 'test' in file_lower:
                      labels.append('tests')

              return list(set(labels))

          # Get PR information
          github_token = os.environ.get('GITHUB_TOKEN')
          repo = os.environ.get('GITHUB_REPOSITORY')
          pr_number = os.environ.get('PR_NUMBER', '${{ github.event.number }}')

          if not all([github_token, repo, pr_number]):
              print("Missing required environment variables")
              exit(0)

          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # Get PR details
          pr_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}'
          pr_response = requests.get(pr_url, headers=headers)

          if pr_response.status_code != 200:
              print(f"Failed to get PR details: {pr_response.status_code}")
              exit(0)

          pr_data = pr_response.json()

          # Get changed files
          files_url = f'https://api.github.com/repos/{repo}/pulls/{pr_number}/files'
          files_response = requests.get(files_url, headers=headers)

          if files_response.status_code != 200:
              print(f"Failed to get changed files: {files_response.status_code}")
              exit(0)

          changed_files = [f['filename'] for f in files_response.json()]

          # Analyze and suggest labels
          suggested_labels = analyze_pr_content(
              pr_data['title'],
              pr_data['body'],
              changed_files
          )

          print(f"Suggested labels for PR #{pr_number}: {suggested_labels}")

          # Apply labels
          if suggested_labels:
              labels_url = f'https://api.github.com/repos/{repo}/issues/{pr_number}/labels'
              labels_response = requests.post(
                  labels_url,
                  headers=headers,
                  json={'labels': suggested_labels}
              )

              if labels_response.status_code == 200:
                  print(f"âœ… Successfully applied labels: {suggested_labels}")
              else:
                  print(f"âŒ Failed to apply labels: {labels_response.status_code}")
          EOF

          python intelligent_labeling.py

  # PR size and complexity analysis
  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Analyze PR size and complexity
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get changed files and calculate metrics
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD | wc -l)
          ADDED_LINES=$(git diff --numstat origin/${{ github.event.repository.default_branch }}...HEAD | awk '{sum += $1} END {print sum}')
          DELETED_LINES=$(git diff --numstat origin/${{ github.event.repository.default_branch }}...HEAD | awk '{sum += $2} END {print sum}')
          TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))

          echo "# ðŸ“Š PR Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Files Changed | $CHANGED_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Added | $ADDED_LINES |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Deleted | $DELETED_LINES |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | $TOTAL_CHANGES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine size label
          if [ $TOTAL_CHANGES -lt 10 ]; then
            SIZE_LABEL="size/XS"
          elif [ $TOTAL_CHANGES -lt 30 ]; then
            SIZE_LABEL="size/S"
          elif [ $TOTAL_CHANGES -lt 100 ]; then
            SIZE_LABEL="size/M"
          elif [ $TOTAL_CHANGES -lt 500 ]; then
            SIZE_LABEL="size/L"
          else
            SIZE_LABEL="size/XL"
          fi

          echo "**Size Classification**: \`$SIZE_LABEL\`" >> $GITHUB_STEP_SUMMARY

          # Apply size label
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/labels \
            -d "{\"labels\": [\"$SIZE_LABEL\"]}"

  # Check for breaking changes
  breaking-changes:
    name: Breaking Changes Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        run: |
          echo "# ðŸš¨ Breaking Changes Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check commit messages for breaking change indicators
          BREAKING_COMMITS=$(git log --oneline origin/${{ github.event.repository.default_branch }}...HEAD | grep -i "breaking\|BREAKING" || true)

          # Check for API changes in Go files
          API_CHANGES=$(git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD | grep -E "\.(go)$" | xargs -I {} git diff origin/${{ github.event.repository.default_branch }}...HEAD -- {} | grep -E "^-.*func.*\(" || true)

          if [ -n "$BREAKING_COMMITS" ]; then
            echo "âš ï¸ **Potential breaking changes detected in commits:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$BREAKING_COMMITS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Apply breaking-change label
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/labels \
              -d '{"labels": ["breaking-change"]}'
          else
            echo "âœ… **No breaking changes detected**" >> $GITHUB_STEP_SUMMARY
          fi

  # Conflict resolution helper
  conflict-resolution:
    name: Conflict Resolution
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    steps:
      - name: Check for merge conflicts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR status
          PR_STATUS=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }} \
            | jq -r '.mergeable')

          echo "# ðŸ”€ Merge Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PR_STATUS" = "false" ]; then
            echo "âŒ **Merge conflicts detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR has merge conflicts that need to be resolved." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Steps to resolve:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Pull the latest changes from the base branch" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge or rebase your branch" >> $GITHUB_STEP_SUMMARY
            echo "3. Resolve any conflicts" >> $GITHUB_STEP_SUMMARY
            echo "4. Push the resolved changes" >> $GITHUB_STEP_SUMMARY

            # Apply needs-rebase label
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/labels \
              -d '{"labels": ["needs-rebase"]}'
          elif [ "$PR_STATUS" = "true" ]; then
            echo "âœ… **No merge conflicts**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR can be merged cleanly." >> $GITHUB_STEP_SUMMARY

            # Remove needs-rebase label if present
            curl -X DELETE \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/labels/needs-rebase || true
          else
            echo "â³ **Merge status unknown**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GitHub is still calculating the merge status." >> $GITHUB_STEP_SUMMARY
          fi

  # PR automation summary
  pr-summary:
    name: PR Automation Summary
    runs-on: ubuntu-latest
    needs: [code-quality, auto-labeling, intelligent-labeling, pr-analysis, ai-rebase]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ¤– PR Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.auto-labeling.result }}" == "success" ]]; then
            echo "âœ… **Auto Labeling**: Applied" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Auto Labeling**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.intelligent-labeling.result }}" == "success" ]]; then
            echo "âœ… **AI Labeling**: Applied" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **AI Labeling**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.pr-analysis.result }}" == "success" ]]; then
            echo "âœ… **PR Analysis**: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **PR Analysis**: Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.ai-rebase.result }}" == "success" ]]; then
            echo "âœ… **AI Rebase**: Completed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.ai-rebase.result }}" == "skipped" ]]; then
            echo "â­ï¸ **AI Rebase**: Skipped (no conflicts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **AI Rebase**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # AI-powered rebase and conflict resolution
  ai-rebase:
    name: AI Rebase & Conflict Resolution
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check for merge conflicts
        id: conflict-check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pr_number = context.issue.number;

            try {
              let pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
              });

              // GitHub may return 'unknown' mergeable_state on first request
              if (pr.data.mergeable_state === 'unknown') {
                await new Promise(r => setTimeout(r, 2000));
                pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr_number,
                });
              }

              const state = pr.data.mergeable_state;
              core.info(`PR #${pr_number} mergeable state: ${state}`);

              if (state === 'dirty' || state === 'behind') {
                return 'true';
              } else {
                return 'false';
              }
            } catch (error) {
              core.error(`Error checking PR: ${error.message}`);
              return 'false';
            }

      - name: Run AI rebase assistant
        if: steps.conflict-check.outputs.result == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/ai-rebase.sh
          .github/scripts/ai-rebase.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ github.event.pull_request.base.ref }}" \
            "${{ github.event.pull_request.head.ref }}"
