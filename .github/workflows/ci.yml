name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write

jobs:
  # This job determines what has changed to optimize workflow execution
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - 'pkg/**'
              - 'cmd/**'
              - 'proto/**'
              - 'scripts/**'
              - '.github/workflows/backend.yml'
            frontend:
              - 'webui/**'
              - '.github/workflows/frontend.yml'

  # Trigger backend workflow
  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || github.event_name == 'push' }}
    uses: ./.github/workflows/backend.yml
    secrets: inherit

  # Trigger frontend workflow
  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' || github.event_name == 'push' }}
    uses: ./.github/workflows/frontend.yml
    secrets: inherit

  # Summary job that depends on both workflows
  ci-complete:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()
    steps:
      - name: Check workflow results
        run: |
          echo "Backend result: ${{ needs.backend.result }}"
          echo "Frontend result: ${{ needs.frontend.result }}"

          # Fail if any required workflow failed
          if [[ "${{ needs.backend.result }}" == "failure" ]] || [[ "${{ needs.frontend.result }}" == "failure" ]]; then
            echo "❌ One or more workflows failed"
            exit 1
          elif [[ "${{ needs.backend.result }}" == "skipped" ]] && [[ "${{ needs.frontend.result }}" == "skipped" ]]; then
            echo "⚠️ All workflows were skipped"
            exit 0
          else
            echo "✅ All workflows completed successfully"
          fi
